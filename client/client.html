<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>METH App</title>
    <style>
        body { margin: 0; font-family: Arial, sans-serif; background: #f2f2f2; }
        #videos { display: flex; justify-content: center; align-items: center; height: 70vh; background: black; }
        video { width: 45%; margin: 5px; border-radius: 10px; background: black; }
        #chat { height: 30vh; background: white; padding: 10px; overflow-y: auto; position: relative; }
        #chat input { width: 80%; padding: 5px; }
        #chat button { padding: 5px; }
        .floating { position: absolute; font-size: 24px; animation: floatUp 5s linear infinite; }
        @keyframes floatUp { 0% { bottom:0; opacity:1; } 100% { bottom:100%; opacity:0; } }
        #logo { position: absolute; top:10px; left:10px; font-size: 32px; font-weight:bold; color: #ff3366; }
    </style>
</head>
<body>
    <div id="logo">M</div>
    <div id="videos">
        <video id="localVideo" autoplay muted></video>
        <video id="remoteVideo" autoplay></video>
    </div>
    <div id="chat">
        <div id="messages"></div>
        <input type="text" id="messageInput" placeholder="Type here..." />
        <button id="sendBtn">Send</button>
    </div>

    <script src="https://cdn.socket.io/4.6.1/socket.io.min.js"></script>
    <script>
        const socket = io('http://localhost:5000');
        const localVideo = document.getElementById('localVideo');
        const remoteVideo = document.getElementById('remoteVideo');
        const sendBtn = document.getElementById('sendBtn');
        const messageInput = document.getElementById('messageInput');
        const messages = document.getElementById('messages');
        const chat = document.getElementById('chat');

        // Floating emojis
        function floatEmoji(emoji) {
            const span = document.createElement('span');
            span.textContent = emoji;
            span.className = 'floating';
            span.style.left = Math.random() * 90 + '%';
            chat.appendChild(span);
            setTimeout(() => span.remove(), 5000);
        }

        // Chat
        sendBtn.onclick = () => {
            const msg = messageInput.value;
            if(!msg) return;
            const msgDiv = document.createElement('div');
            msgDiv.textContent = "You: " + msg;
            messages.appendChild(msgDiv);
            socket.emit('chatMessage', msg);
            floatEmoji('ðŸ’–');
            floatEmoji('ðŸŒ¸');
            messageInput.value = '';
        };

        socket.on('chatMessage', msg => {
            const msgDiv = document.createElement('div');
            msgDiv.textContent = "Friend: " + msg;
            messages.appendChild(msgDiv);
            floatEmoji('ðŸ’–');
            floatEmoji('ðŸŒ¸');
        });

        // WebRTC setup
        let localStream;
        let peerConnection;
        const config = { iceServers: [{ urls: 'stun:stun.l.google.com:19302' }] };

        async function startVideo() {
            localStream = await navigator.mediaDevices.getUserMedia({ video: true, audio: true });
            localVideo.srcObject = localStream;
            peerConnection = new RTCPeerConnection(config);

            localStream.getTracks().forEach(track => peerConnection.addTrack(track, localStream));

            peerConnection.ontrack = e => { remoteVideo.srcObject = e.streams[0]; }

            peerConnection.onicecandidate = e => {
                if(e.candidate) socket.emit('ice-candidate', e.candidate);
            }

            socket.on('offer', async offer => {
                await peerConnection.setRemoteDescription(offer);
                const answer = await peerConnection.createAnswer();
                await peerConnection.setLocalDescription(answer);
                socket.emit('answer', answer);
            });

            socket.on('answer', async answer => {
                await peerConnection.setRemoteDescription(answer);
            });

            socket.on('ice-candidate', async candidate => {
                try { await peerConnection.addIceCandidate(candidate); } catch(e){console.error(e);}
            });

            if(!peerConnection.localDescription) {
                const offer = await peerConnection.createOffer();
                await peerConnection.setLocalDescription(offer);
                socket.emit('offer', offer);
            }
        }

        startVideo();
    </script>
</body>
</html>